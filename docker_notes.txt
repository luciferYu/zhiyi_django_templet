##  安装
# 移除旧版本
sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-selinux \
                  docker-engine-selinux \
                  docker-engine

sudo yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2

sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

sudo yum install docker-ce  # 安装最新版本
sudo yum install docker-ce-<VERSION STRING>  # 安装指定版本
sudo systemctl start docker   #启动服务


## 更换国内镜像源 详见
https://docs.docker.com/config/daemon/#troubleshoot-conflicts-between-the-daemonjson-and-startup-scripts


## 容器使用
cd /data/web/WochuServerCenter/;/usr/local/python-3.6/bin/uwsgi --ini uwsgi.ini

docker commit -m="WochuServerCenter" -a="yuzhiyi" fc88008c76b1 yuzhiyi/wsc:v1

docker run -d -p 81:8000 yuzhiyi/wsc:v2  /usr/bin/cd /data/web/WochuServerCenter/; /usr/local/python-3.6/bin/uwsgi --ini uwsgi.ini

docker run -d -p 81:8000 yuzhiyi/wsc:v7   /usr/local/python-3.6/bin/uwsgi --ini /data/web/WochuServerCenter/dockeruwsgi.ini

docker run -it yuzhiyi/wsc:v3 /bin/bash

1：docker attach id  刚方法进入之后，exit退出就会导致容器stop

2：docker exec -it containerID /bin/bash   这个命令exit退出，ok容器还在运行


## 镜像
# 从dockerfile里 建立镜像
docker build -t friendlyhello .

#删除镜像
docker rmi 327fb3ab8b87

#删除所有停止运行的容器
docker container prune

# 主机间共享镜像
docker save -o /tmp/wsc.dimg yuzhiyi/wsc:v7
docker load --input /tmp/wsc.dimg

##  上传镜像
docker login
docker tag image username/repository:tag
For example:
docker tag friendlyhello gordon/get-started:part2
docker push username/repository:tag

docker run -d -p 8022:22 base


##  启动services
docker swarm init     #初始化  

#启动命令
[root@localhost wsc]# docker service ls      # 查看服务
ID                  NAME                    MODE                REPLICAS            IMAGE                 PORTS
jcefjqdid04w        wochuservercenter_web   replicated          3/3                 lucifery/wsc:latest   *:8000->80/tcp

[root@localhost wsc]# docker service ps wochuservercenter_web    #查看服务详细信息
ID                  NAME                      IMAGE                 NODE                    DESIRED STATE       CURRENT STATE           ERROR               PORTS
vcm9891tbhor        wochuservercenter_web.1   lucifery/wsc:latest   localhost.localdomain   Running             Running 2 minutes ago                       
maklggozrz7x        wochuservercenter_web.2   lucifery/wsc:latest   localhost.localdomain   Running             Running 2 minutes ago                       
yzdthi5my3ns        wochuservercenter_web.3   lucifery/wsc:latest   localhost.localdomain   Running             Running 2 minutes ago        
               
[root@localhost wsc]# docker container ls -q    #查看容器sha1
5705f2fb1156
badec83d6713
7193b7b90aca

[root@localhost wsc]# docker ps    # 验证容器sha1 与serviceid不同
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS               NAMES
5705f2fb1156        lucifery/wsc:latest   "/usr/local/python-3…"   3 minutes ago       Up 3 minutes                            wochuservercenter_web.2.maklggozrz7xkqm2uacsb2wxr
badec83d6713        lucifery/wsc:latest   "/usr/local/python-3…"   3 minutes ago       Up 3 minutes                            wochuservercenter_web.1.vcm9891tbhornzebwpzabgxd0
7193b7b90aca        lucifery/wsc:latest   "/usr/local/python-3…"   3 minutes ago       Up 3 minutes                            wochuservercenter_web.3.yzdthi5my3nsasg4sfce2v685

[root@localhost wsc]# docker stack ls  #查看stack
NAME                SERVICES            ORCHESTRATOR
wochuservercenter   1                   Swarm

#扩展app的容器数量 修改docker-compose.yml文件的  replicas: 5 数量 重新启动命令运行 
docker stack deploy -c docker-compose.yml wochuservercenter     #扩展app命令 与启动命令相同
Updating service wochuservercenter_web (id: wozz9ilckg1o96jyvl5j2oojy)
image lucifery/wsc:latest could not be accessed on a registry to record
its digest. Each node will access lucifery/wsc:latest independently,
possibly leading to different nodes running different
versions of the image.

[root@localhost web]# docker stack rm wochuservercenter     #停止服务
Removing service wochuservercenter_web
Removing network wochuservercenter_webnet

docker swarm leave --force    #停止swarm


## 启动swarm
[root@localhost wsc]# docker swarm init --listen-addr 192.168.14.35:2377  --advertise-addr 192.168.14.35   # 启动swarm 集群
Swarm initialized: current node (8k0s3wlqux5assh69opkr3bd1) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-60bnt6hv8lgwgaonel6qa4rn8ewt2u5v99h7sw89s2oa7tfm69-6dwndnolcarwkf31sq6rdr9nk 192.168.14.35:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

[root@localhost wsc]# docker swarm join-token manager     # 显示已manager加入集群的token
To add a manager to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-4ck8lws73d5kn8qfku7zor3a7q8stmtjgrpw74te3er1ytbqbp-4jt8cjwfn1bgd0e57b00fqqj8 192.168.14.35:2377

[root@localhost ~]# docker swarm join --token SWMTKN-1-60bnt6hv8lgwgaonel6qa4rn8ewt2u5v99h7sw89s2oa7tfm69-35uu695fxifz5wyo1b6lnxpex 192.168.14.35:2377  # 加入swarm

This node joined a swarm as a manager.


[root@localhost wsc]# docker stack deploy -c docker-compose.yml wochuservercenter  #此时在集群的manager 启动服务
Creating network wochuservercenter_webnet
Creating service wochuservercenter_web

[root@localhost wsc]# docker service ps wochuservercenter_web  # 此时服务已启动 但是发现另一个节点没有镜像，是因为我把该镜像设为私有了
ID                  NAME                          IMAGE                 NODE                    DESIRED STATE       CURRENT STATE                 ERROR                              PORTS
pk7wce0nik01        wochuservercenter_web.1       lucifery/wsc:latest   localhost.localdomain   Running             Running about a minute ago                                       
z30lx63jx0u2        wochuservercenter_web.2       lucifery/wsc:latest   localhost.localdomain   Running             Running 51 seconds ago                                           
lvic42botjh6         \_ wochuservercenter_web.2   lucifery/wsc:latest   localhost.localdomain   Shutdown            Rejected 57 seconds ago       "No such image: lucifery/wsc:l…"   
chxa22ig7d87         \_ wochuservercenter_web.2   lucifery/wsc:latest   localhost.localdomain   Shutdown            Rejected about a minute ago   "No such image: lucifery/wsc:l…"   
phpapa0cwes8        wochuservercenter_web.3       lucifery/wsc:latest   localhost.localdomain   Running             Running about a minute ago                                       
85uy3y02bik8        wochuservercenter_web.4       lucifery/wsc:latest   localhost.localdomain   Running             Running 56 seconds ago                                           
wh8ugv6mbddh         \_ wochuservercenter_web.4   lucifery/wsc:latest   localhost.localdomain   Shutdown            Rejected about a minute ago   "No such image: lucifery/wsc:l…"   
cs82sehyiu1o        wochuservercenter_web.5       lucifery/wsc:latest   localhost.localdomain   Running             Running 51 seconds ago                                           
cq8y5cxx6iqq         \_ wochuservercenter_web.5   lucifery/wsc:latest   localhost.localdomain   Shutdown            Rejected 56 seconds ago       "No such image: lucifery/wsc:l…"   
1qnvvy2f1b65         \_ wochuservercenter_web.5   lucifery/wsc:latest   localhost.localdomain   Shutdown            Rejected about a minute ago   "No such image: lucifery/wsc:l…"   

docker stack deploy -c docker-compose.yml wochuservercenter  # 迭代和更新集群

[root@localhost wsc]# docker stack ps wochuservercenter
ID                  NAME                          IMAGE                 NODE                DESIRED STATE       CURRENT STATE                 ERROR                              PORTS
nfkpprkwsdz6        wochuservercenter_web.1       lucifery/wsc:latest   node1               Running             Running 36 seconds ago                                           
pk7wce0nik01         \_ wochuservercenter_web.1   lucifery/wsc:latest   node1               Shutdown            Shutdown 37 seconds ago                                          
v18whw6frln9        wochuservercenter_web.2       lucifery/wsc:latest   node2               Running             Running about a minute ago                                       
z30lx63jx0u2         \_ wochuservercenter_web.2   lucifery/wsc:latest   node1               Shutdown            Shutdown about a minute ago                                      
lvic42botjh6         \_ wochuservercenter_web.2   lucifery/wsc:latest   node2               Shutdown            Rejected 27 minutes ago       "No such image: lucifery/wsc:l…"   
chxa22ig7d87         \_ wochuservercenter_web.2   lucifery/wsc:latest   node2               Shutdown            Rejected 27 minutes ago       "No such image: lucifery/wsc:l…"   
wqjylqqucnql        wochuservercenter_web.3       lucifery/wsc:latest   node1               Running             Running 50 seconds ago                                           
phpapa0cwes8         \_ wochuservercenter_web.3   lucifery/wsc:latest   node1               Shutdown            Shutdown 51 seconds ago                                          
dmwicodpalha        wochuservercenter_web.4       lucifery/wsc:latest   node2               Running             Running about a minute ago                                       
85uy3y02bik8         \_ wochuservercenter_web.4   lucifery/wsc:latest   node1               Shutdown            Shutdown about a minute ago                                      
wh8ugv6mbddh         \_ wochuservercenter_web.4   lucifery/wsc:latest   node2               Shutdown            Rejected 27 minutes ago       "No such image: lucifery/wsc:l…"   
z75ib4j3m25c        wochuservercenter_web.5       lucifery/wsc:latest   node2               Running             Running about a minute ago                                       
cs82sehyiu1o         \_ wochuservercenter_web.5   lucifery/wsc:latest   node1               Shutdown            Shutdown about a minute ago                                      
cq8y5cxx6iqq         \_ wochuservercenter_web.5   lucifery/wsc:latest   node2               Shutdown            Rejected 27 minutes ago       "No such image: lucifery/wsc:l…"   
1qnvvy2f1b65         \_ wochuservercenter_web.5   lucifery/wsc:latest   node2               Shutdown            Rejected 27 minutes ago       "No such image: lucifery/wsc:l…"   

[root@localhost wsc]# hostname
node1
[root@localhost wsc]# docker ps
CONTAINER ID        IMAGE                 COMMAND                  CREATED              STATUS              PORTS               NAMES
6fa0ad1e9fbc        lucifery/wsc:latest   "/usr/local/python-3…"   About a minute ago   Up About a minute                       wochuservercenter_web.1.nfkpprkwsdz6kaoyiz8fzgt52
267ab4065384        lucifery/wsc:latest   "/usr/local/python-3…"   About a minute ago   Up About a minute                       wochuservercenter_web.3.wqjylqqucnqldjn7lk91tpwq1

[root@localhost ~]# hostname
node2
[root@localhost ~]# docker ps
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                  NAMES
1996517151d6        lucifery/wsc:latest   "/usr/local/python-3…"   2 minutes ago       Up 2 minutes                               wochuservercenter_web.2.v18whw6frln9tsbf2rk5pk4zl
da211108712a        lucifery/wsc:latest   "/usr/local/python-3…"   2 minutes ago       Up 2 minutes                               wochuservercenter_web.4.dmwicodpalhavrsglph8vy1ob
3b6df8d185fe        lucifery/wsc:latest   "/usr/local/python-3…"   2 minutes ago       Up 2 minutes                               wochuservercenter_web.5.z75ib4j3m25c65r9mof8nq661


##  stack
[root@localhost wsc]# docker stack rm wochuservercenter    # 先停止之前的服务
Removing service wochuservercenter_web
Removing network wochuservercenter_webnet

[root@localhost wsc]# docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
[root@localhost wsc]# docker stack deploy -c docker-compose.yml wsc     #创建新的服务
Creating service wsc_visualizer
Creating service wsc_web

[root@localhost wsc]# docker stack ls
NAME                SERVICES            ORCHESTRATOR
wsc                 2                   Swarm

[root@localhost wsc]# docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                             PORTS
daby00p8swqg        wsc_visualizer      replicated          0/1                 dockersamples/visualizer:stable   *:8080->8080/tcp
nwx7bmnn9eb7        wsc_web             replicated          5/5                 lucifery/wsc:latest               *:80->8000/tcp

[root@localhost wsc]# docker service ps wsc_visualizer
ID                  NAME                IMAGE                             NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS
nenwol3v7rqu        wsc_visualizer.1    dockersamples/visualizer:stable   node1               Running             Running about a minute ago    
                   
[root@localhost wsc]# docker service ps wsc_web
ID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS
gxcpa2rtrgp5        wsc_web.1           lucifery/wsc:latest   node1               Running             Running 3 minutes ago                       
1w0colra9x54        wsc_web.2           lucifery/wsc:latest   node2               Running             Running 3 minutes ago                       
4qqank4kndgn        wsc_web.3           lucifery/wsc:latest   node2               Running             Running 3 minutes ago                       
acfqdwm45ka5        wsc_web.4           lucifery/wsc:latest   node1               Running             Running 3 minutes ago                       
kif0vaqachyr        wsc_web.5           lucifery/wsc:latest   node2               Running             Running 3 minutes ago  

# 增加持久化存储 redis
[root@localhost wsc]# docker stack deploy -c docker-compose.yml wsc
Updating service wsc_web (id: nwx7bmnn9eb7ycu39xvgrvcd2)
image lucifery/wsc:latest could not be accessed on a registry to record
its digest. Each node will access lucifery/wsc:latest independently,
possibly leading to different nodes running different
versions of the image.

Updating service wsc_visualizer (id: daby00p8swqgxjweygmhhrj5p)
Creating service wsc_redis


[root@localhost wsc]# docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                             PORTS
jn0h4q4tapnf        wsc_redis           replicated          0/1                 redis:latest                      *:6379->6379/tcp
daby00p8swqg        wsc_visualizer      replicated          1/1                 dockersamples/visualizer:stable   *:8080->8080/tcp
nwx7bmnn9eb7        wsc_web             replicated          5/5                 lucifery/wsc:latest               *:80->8000/tcp




docker stack ls                                            # List stacks or apps
docker stack deploy -c <composefile> <appname>  # Run the specified Compose file
docker service ls                 # List running services associated with an app
docker service ps <service>                  # List tasks associated with an app
docker inspect <task or container>                   # Inspect task or container
docker container ls -q                                      # List container IDs
docker stack rm <appname>                             # Tear down an application
docker swarm leave --force      # Take down a single node swarm from the manager